<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner â€“ Tooro Express Media</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:Arial}
button,input{padding:8px;margin:4px;border-radius:6px;border:none}
button{background:#4caf50;color:#fff;font-weight:bold;cursor:pointer}
.video-wrap{position:relative;max-width:900px;margin:auto}
#liveVideo{width:100%;border-radius:12px;background:#000}
#bgVideo,#bgImage{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none}
#overlay{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.6);padding:6px 12px;border-radius:6px}
</style>
</head>
<body>
<h2 style="text-align:center">Owner Dashboard</h2>
<div style="text-align:center">
<button id="goLive">GO LIVE</button>
<button id="goOff">GO OFFLINE</button>
</div>
<div class="video-wrap">
  <img id="bgImage">
  <video id="bgVideo" loop></video>
  <video id="liveVideo" autoplay muted playsinline></video>
  <div id="overlay"><span id="title">Program Title</span></div>
</div>
<div style="text-align:center">
<input id="titleInput" placeholder="Program title">
<button onclick="setTitle()">Set Title</button><br>
<input type="file" accept="image/*,video/*" onchange="setBackground(this)">
<label><input type="checkbox" id="bgSound"> Background sound</label>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyDyIloGwy7UzZUAqodgZNvNCiBou02RbGQ",authDomain:"livestream-trial.firebaseapp.com",databaseURL:"https://livestream-trial-default-rtdb.firebaseio.com",projectId:"livestream-trial",storageBucket:"livestream-trial.appspot.com"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};
const viewersRef=db.ref("viewers");
const pcs={};
let localStream=null;
const liveVideo=document.getElementById("liveVideo");

async function startStream(){
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  liveVideo.srcObject=localStream;
}

document.getElementById("goLive").onclick=async()=>{
  if(!localStream) await startStream();
};

document.getElementById("goOff").onclick=()=>{
  Object.values(pcs).forEach(pc=>pc.close());
  viewersRef.remove();
};

viewersRef.on("child_added", async snap=>{
  if(!localStream) return;
  const id=snap.key;
  if(pcs[id]) return;
  const pc=new RTCPeerConnection(rtcConfig);
  pcs[id]=pc;
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.onicecandidate=e=>e.candidate&&db.ref(`webrtc/${id}/ownerICE`).push(JSON.stringify(e.candidate));
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref(`webrtc/${id}/offer`).set(JSON.stringify(offer));
  db.ref(`webrtc/${id}/answer`).on("value",s=>s.val()&&pc.setRemoteDescription(JSON.parse(s.val())));
  db.ref(`webrtc/${id}/viewerICE`).on("child_added",s=>pc.addIceCandidate(JSON.parse(s.val())));
});

function setTitle(){db.ref("title").set(document.getElementById("titleInput").value)}
db.ref("title").on("value",s=>document.getElementById("title").textContent=s.val()||"Program Title");

function setBackground(inp){
 const f=inp.files[0];if(!f)return;const url=URL.createObjectURL(f);
 const bgV=document.getElementById("bgVideo");const bgI=document.getElementById("bgImage");
 if(f.type.startsWith("video")){
  bgV.src=url;bgV.muted=!document.getElementById("bgSound").checked;bgV.play();bgV.style.display="block";bgI.style.display="none";
 }else{bgI.src=url;bgI.style.display="block";bgV.style.display="none"}
}
</script>
</body>
</html>
