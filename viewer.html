<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viewer – Tooro Express Media (FIXED)</title>
<style>
body{margin:0;background:#111;color:#fff;text-align:center;font-family:Arial}
#status{margin-top:10px;font-weight:bold}
video{width:95%;max-width:900px;margin-top:20px;border-radius:12px;background:#000}
</style>
</head>
<body>
<h2 id="title">Waiting for live…</h2>
<div id="status">OFFLINE</div>
<video id="viewerVideo" autoplay playsinline muted></video>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyDyIloGwy7UzZUAqodgZNvNCiBou02RbGQ",authDomain:"livestream-trial.firebaseapp.com",databaseURL:"https://livestream-trial-default-rtdb.firebaseio.com",projectId:"livestream-trial",storageBucket:"livestream-trial.appspot.com"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

// viewer id (stable)
const viewerRef=db.ref("viewers").push();
const viewerId=viewerRef.key;
viewerRef.set(true);
viewerRef.onDisconnect().remove();

const pc=new RTCPeerConnection(rtcConfig);
const video=document.getElementById("viewerVideo");
const status=document.getElementById("status");

pc.ontrack=e=>{
  video.srcObject=e.streams[0];
  video.muted=false;
  status.textContent="LIVE";
  status.style.color="red";
};

pc.onicecandidate=e=>{
  if(e.candidate){
    db.ref(`webrtc/${viewerId}/viewerICE`).push(JSON.stringify(e.candidate));
  }
};

db.ref(`webrtc/${viewerId}/offer`).on("value",async s=>{
  if(!s.val()) return;
  await pc.setRemoteDescription(JSON.parse(s.val()));
  const ans=await pc.createAnswer();
  await pc.setLocalDescription(ans);
  db.ref(`webrtc/${viewerId}/answer`).set(JSON.stringify(ans));
});

db.ref(`webrtc/${viewerId}/ownerICE`).on("child_added",s=>{
  pc.addIceCandidate(JSON.parse(s.val()));
});

// program title
db.ref("title").on("value",s=>{
  document.getElementById("title").textContent=s.val()||"Waiting for live…";
});

// live status
db.ref("liveStatus").on("value",s=>{
  if(!s.val()){
    status.textContent="OFFLINE";
    status.style.color="gray";
  }
});
</script>
</body>
</html>
